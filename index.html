<!-- بخش جاوااسکریپت -->
<script>
  function toPersianNumber(input) {
    const persianDigits = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
    return input.toString().replace(/\d/g, d => persianDigits[d]);
  }

  function animateElement(id, content) {
    const el = document.getElementById(id);
    el.classList.remove("fade-update");
    void el.offsetWidth;
    el.innerHTML = content;
    el.classList.add("fade-update");
  }

  function getColorClass(value) {
    if (value > 0) return "text-green-500";
    if (value < 0) return "text-red-500";
    return "text-black";
  }

  async function fetchData() {
    try {
      const response = await fetch("https://brsapi.ir/Api/Market/Gold_Currency.php?key=FreeTZPrEbgTZzbW2SSGXOlzjlulRFcz");
      const data = await response.json();

      const items = data.gold;
      const gold18 = items.find(i => i.symbol === "IR_GOLD_18K");

      const usd = data.currency.find(i => i.symbol === "USD");
      const xauusd = data.currency.find(i => i.symbol === "XAUUSD");

      if (usd) {
        const usdColor = getColorClass(usd.change_percent);
        const usdText = `<span class="${usdColor}">دلار: ${toPersianNumber(usd.price.toLocaleString())} (${toPersianNumber(Math.abs(usd.change_percent).toFixed(2))}%)</span>`;
        animateElement("usd-info", usdText);
      }

      if (xauusd) {
        const xauColor = getColorClass(xauusd.change_percent);
        const xauText = `<span class="${xauColor}">انس: ${toPersianNumber(xauusd.price.toLocaleString())} (${toPersianNumber(Math.abs(xauusd.change_percent).toFixed(2))}%)</span>`;
        animateElement("xauusd-info", xauText);
      }

      if (gold18) {
        animateElement("gold-price", toPersianNumber(gold18.price.toLocaleString()));
        
        let value = gold18.change_value;
        let percent = gold18.change_percent;
        let valueStr = Math.abs(value).toLocaleString();
        let percentStr = Math.abs(percent).toFixed(2);
        let valueText = toPersianNumber(valueStr);
        let percentText = toPersianNumber(percentStr);
        let goldChangeColor = getColorClass(percent);

        animateElement("gold-change", `<span class="${goldChangeColor}">${valueText} (%${percentText})</span>`);

        // رنگ ثابت برای باکس طلا
        const goldBox = document.getElementById("gold-box");
        goldBox.className = "bg-gradient-to-br from-green-800 to-green-400 rounded-xl shadow-md p-6 text-center";

        const goldPrice = gold18.price;
        const myGoldGrams = 438.44;
        const goldPurity = 750;
        const commission = 30000;

        document.getElementById("portfolio-title").innerText = `ارزش طلای آبشده (${toPersianNumber(myGoldGrams.toLocaleString())} گرم)`;
        animateElement("gold-amount");
        const totalGoldValue = ((goldPrice - commission) * goldPurity / 750 ) * myGoldGrams;
        animateElement("portfolio-value", toPersianNumber(Math.floor(totalGoldValue).toLocaleString()));

        const profitBox = document.getElementById("profit-box");
        profitBox.className = "bg-gradient-to-br from-blue-800 to-blue-400 rounded-xl shadow-md p-6 text-center";
        try {
          const total = 4524;
          const ayarResponse = await fetch("https://brsapi.ir/Api/Tsetmc/AllSymbols.php?key=FreeTZPrEbgTZzbW2SSGXOlzjlulRFcz&type=1");
          const symbols = await ayarResponse.json();
          const ayar = symbols.find(i => i.l18 === "عیار");
          if (ayar && ayar.pc) {
            const result = total * (ayar.pc / 10);
            const combined = totalGoldValue + result;
            animateElement("gold-amount", toPersianNumber(Math.floor(combined).toLocaleString()));
            animateElement("portfolio-value", toPersianNumber(Math.floor(totalGoldValue).toLocaleString()));
            animateElement("profit-box", `
              <div class="text-xl font-extrabold drop-shadow text-yellow-300">
                ارزش صندوق عیار (${toPersianNumber(total.toLocaleString())} واحد)
              </div>
              <div class="text-2xl font-extrabold drop-shadow text-white mt-2">
                ${toPersianNumber(Math.floor(result).toLocaleString())}
              </div>
              <small class="block mt-1 text-base text-white persian-numbers drop-shadow">
                قیمت پایانی: ${toPersianNumber(Number(ayar.pc).toLocaleString())} (${toPersianNumber(Number(ayar.pcp).toFixed(2))}%)
              </small>
            `);
          } else {
            animateElement("profit-box", "صندوق عیار یافت نشد");
          }
        } catch (err) {
          console.error("خطا در دریافت اطلاعات صندوق عیار:", err);
          animateElement("profit-box", "خطا در دریافت قیمت صندوق");
        }

        const now = new Date();
        const formattedDate = toPersianNumber(now.toLocaleDateString("fa-IR"));
        const formattedTime = toPersianNumber(now.toLocaleTimeString("fa-IR").replace(/:\d+$/, ''));
        document.getElementById("last-update").innerText = `آخرین به‌روزرسانی: ${formattedDate} ساعت ${formattedTime}`;
      } else {
        animateElement("gold-price", "اطلاعات موجود نیست");
        animateElement("portfolio-value", "نامشخص");
        const profitBox = document.getElementById("");
        profitBox.className = "rounded-xl p-6 text-center text-white bg-gray-500 persian-numbers";
        animateElement("profit-box", "اطلاعات موجود نیست");
      }

    } catch (err) {
      console.error("خطا:", err);
      animateElement("gold-price", "خطا در دریافت");
      animateElement("portfolio-value", "نامشخص");
      const profitBox = document.getElementById("profit-box");
      profitBox.className = "rounded-xl p-6 text-center text-white bg-gray-500 persian-numbers";
      animateElement("profit-box", "خطا در محاسبه سود/زیان");
    }
  }

  fetchData();
</script>